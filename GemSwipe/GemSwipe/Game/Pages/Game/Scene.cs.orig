using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
<<<<<<< HEAD:GemSwipe/GemSwipe/Game/Pages/Game/Scene.cs
using GemSwipe.Data.Level;
using GemSwipe.Game.Entities;
using GemSwipe.Game.Models;
using GemSwipe.Game.Pages.Game.Floors;
using GemSwipe.Game.SkiaEngine;
=======
using GemSwipe.Data;
using GemSwipe.GameEngine.Game.Floors;
using GemSwipe.Data.Level;
using GemSwipe.GameEngine.SkiaEngine;
using GemSwipe.Models;
using Newtonsoft.Json;
>>>>>>> levelconfig, repository:GemSwipe/GemSwipe/GameEngine/Game/Scene.cs
using SkiaSharp;
using Xamarin.Forms;

namespace GemSwipe.Game.Pages.Game
{
    public class Scene : SkiaView
    {
        private readonly float _initialMarginX;
        private readonly float _initialMarginY;

        public Board CurrentBoard { get; private set; }
        public StartingFloor StartingFloor { get; private set; }

        private const int MsPerBoardNavigation = 200;
        private readonly double _boardMargin;
        private readonly IList<Floor> _floors;
        private float _floorHeight;
        private float _floorMargin;
        private int _floorCount;
        private int _currentFloor;

<<<<<<< HEAD:GemSwipe/GemSwipe/Game/Pages/Game/Scene.cs
        public BoardSetup SetupBoard;
=======
        public LevelConfiguration _LevelConfiguration;
>>>>>>> levelconfig, repository:GemSwipe/GemSwipe/GameEngine/Game/Scene.cs

        public Scene(SKCanvas canvas, float x, float y, float height, float width) : base(canvas, x, y, height, width)
        {
            _floorCount = 1;
            _currentFloor = 1;
            _floors = new List<Floor>();

            _floorHeight = height;
            _floorMargin = height * 1.5f;

            var startingFloor = new StartingFloor(canvas, X, Y, _floorHeight, width, 1);
            _floors.Add(startingFloor);
            AddChild(startingFloor);
            StartingFloor = startingFloor;
        }


        public void Reset()
        {
            _currentFloor = 0;
            foreach (var floor in _floors)
            {
                if (floor is PlayableFloor)
                    floor.Dispose();
            }
        }

        public void SetLevelConfig(LevelConfiguration levelConfig)
        {
            _LevelConfiguration = levelConfig;
        }

        public async Task EndGame()
        {
            _floorCount++;
            var endFloor = new EndFloor(Canvas, X, -Y + _floorMargin, _floorHeight, Width, SetupBoard.LevelId);
            _floors.Add(endFloor);
            AddChild(endFloor);
            await GoToNextFloor();
        }

        public async Task NextBoard(BoardSetup boardSetup)
        {
            _floorCount++;
            var floorSetup = new PlayableFloorSetup(boardSetup, _floorCount - 1, false, (_floorCount - 1).ToString());
            var floor = new PlayableFloor(Canvas, X, -Y + _floorMargin, _floorHeight, Width, floorSetup);
            AddChild(floor);

            _floors.Add(floor);

            // Recycle Boards
            ClearFloorsStack();
            await GoToNextFloor();
        }


        private async Task GoToNextFloor()
        {
            var floor = _floors.Last();

            var oldX = _x;
            var oldY = _y;
            var zoomScaleTarget = 0.5;
            var newX = -(floor.X - X) + _initialMarginX;
            var newY = -(floor.Y - Y) + _initialMarginY;
            int animationTimeScale = MsPerBoardNavigation * 4;

            this.Animate("moveY", p => _y = (float)p, oldY, newY, 8, (uint)1000, Easing.SinInOut);
            await Task.Delay(1000);

            if (floor is PlayableFloor)
                CurrentBoard = (floor as PlayableFloor).Board;
        }

<<<<<<< HEAD:GemSwipe/GemSwipe/Game/Pages/Game/Scene.cs
        public async Task DisplayBoard(int levelId)
=======
        public async Task NextTransitionFloor()
>>>>>>> levelconfig, repository:GemSwipe/GemSwipe/GameEngine/Game/Scene.cs
        {
            var floor = new TransitionFloor(Canvas, X, -Y + _floorMargin, _floorHeight, Width, _LevelConfiguration);
            AddChild(floor);

<<<<<<< HEAD:GemSwipe/GemSwipe/Game/Pages/Game/Scene.cs
            //string msg = await LevelLoader.LoadStringAsync(@"d:\movie.json");
            try
            {
                string msg = await LevelLoader.LoadStringAsync("Data/Level/LevelResources.json");

                //var floorSetup = new TransitionFloorSetup(_floorCount, "coucou", "Transitionfloor");
                var floorSetup = new TransitionFloorSetup(_floorCount, "coucou", msg);
                var floor = new TransitionFloor(Canvas, X, -Y + _floorMargin, _floorHeight, Width, floorSetup);
                AddChild(floor);

                _floors.Add(floor);

                // Recycle Boards
                if (_floors.Count > 3)
                {
                    var floorToDispose = _floors[1];
                    _floors.RemoveAt(1);
                    floorToDispose.Dispose();
                }
                await GoToNextFloor();
                floor.Tapped += () => { NextBoard(levelId); };
            }
            catch (Exception e)
            {
                throw;
            }
=======
            _floors.Add(floor);
>>>>>>> levelconfig, repository:GemSwipe/GemSwipe/GameEngine/Game/Scene.cs

            // Recycle Boards
            ClearFloorsStack();

            await GoToNextFloor();
            floor.Tapped += NextBoard;
        }

        public async Task EndFloor()
        {
            var floor = new EndFloor(Canvas, X, -Y + _floorMargin, _floorHeight, Width, SetupBoard.LevelId);
            AddChild(floor);

            _floors.Add(floor);

            // Recycle Boards
            ClearFloorsStack();
            await GoToNextFloor();
        }


        //method overload for event floor.Tapped subscription
        private async void NextBoard(int levelId)
        {
            _floorCount++;
<<<<<<< HEAD:GemSwipe/GemSwipe/Game/Pages/Game/Scene.cs
            var floorSetup = new PlayableFloorSetup(SetupBoard, _floorCount - 1, false, levelId.ToString());
=======
            BoardSetup boardSetup = new BoardSetup(_LevelConfiguration);
            var floorSetup = new PlayableFloorSetup(boardSetup, _floorCount - 1, false, (_floorCount - 1).ToString());
>>>>>>> levelconfig, repository:GemSwipe/GemSwipe/GameEngine/Game/Scene.cs
            var floor = new PlayableFloor(Canvas, X, -Y + _floorMargin, _floorHeight, Width, floorSetup);
            AddChild(floor);

            _floors.Add(floor);

            // Recycle Boards
            ClearFloorsStack();
            await GoToNextFloor();
        }

        public void ClearFloorsStack()
        {
            if (_floors.Count > 3)
            {
                var floorToDispose = _floors[1];
                _floors.RemoveAt(1);
                floorToDispose.Dispose();
            }
        }

        protected override void Draw()
        {

        }

        public async Task ResetBoard()
        {
            CurrentBoard.Reset();
        }
    }
}
